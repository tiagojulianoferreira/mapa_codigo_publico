document.addEventListener("DOMContentLoaded",()=>{const generalSearchInput=document.getElementById("generalSearchInput");const languageFilter=document.getElementById("languageFilter");const licenseFilter=document.getElementById("licenseFilter");const clearFiltersBtn=document.getElementById("clearFilters");const totalReposGlobal=document.getElementById("totalReposGlobal");const mostUsedLanguageGlobal=document.getElementById("mostUsedLanguageGlobal");const mostUsedLicenseGlobal=document.getElementById("mostUsedLicenseGlobal");const filteredReposCount=document.getElementById("filteredReposCount");const topLanguagesTbody=document.getElementById("topLanguagesTbody");const noTopLanguagesMessage=document.getElementById("noTopLanguagesMessage");const topReposTbody=document.getElementById("topReposTbody");const noTopReposMessage=document.getElementById("noTopReposMessage");const allReposTable=document.getElementById("allReposTable");const allReposTbody=document.getElementById("allReposTbody");const allReposTableHeaders=document.querySelectorAll("#allReposTable thead tr:first-child th");const allReposFilterInputs=document.querySelectorAll("#allReposTable #filterRow .filter-input");const clustersTbody=document.getElementById("clustersTbody");const noClustersMessage=document.getElementById("noClustersMessage");let allInstitutionsData=[];let clusterDescriptions=[];let allFlattenedRepos=[];let calculatedTop10Languages=[];let availableLanguages=new Set;let availableLicenses=new Set;let currentSortColumn=null;let currentSortDirection="asc";let columnFilters={};async function fetchAndProcessData(){try{const response=await fetch("repositorios_federais_com_clusters_visualizado.json");if(!response.ok){allReposTbody.innerHTML=`<tr><td colspan="8" class="error-message">Erro ao carregar os dados: Arquivo 'repositorios_federais_com_clusters_visualizado.json' não encontrado ou inacessível. Verifique o caminho e nome do arquivo.</td></tr>`;topReposTbody.innerHTML=`<tr><td colspan="5" class="error-message">Erro ao carregar top repositórios.</td></tr>`;clustersTbody.innerHTML=`<tr><td colspan="2" class="error-message">Erro ao carregar clusters.</td></tr>`;topLanguagesTbody.innerHTML=`<tr><td colspan="3" class="error-message">Erro ao carregar top linguagens.</td></tr>`;throw new Error(`Erro ao carregar o JSON: ${response.statusText} (Status: ${response.status})`)}const jsonData=await response.json();allInstitutionsData=jsonData.institutions_data||[];clusterDescriptions=jsonData.cluster_descriptions||[];const tempLanguageCounts={};allInstitutionsData.forEach(institution=>{const institutionName=institution["Nome Completo"];const institutionSigla=institution.Sigla;institution.Repositorios.forEach(repo=>{repo.Instituicao=institutionName;repo.SiglaInstituicao=institutionSigla;if(repo["Cluster_ID"]===undefined||repo["Cluster_ID"]===null){repo["Cluster_ID"]="N/A"}allFlattenedRepos.push(repo);if(repo["Linguagem Principal"]&&repo["Linguagem Principal"]!=="N/A"&&repo["Linguagem Principal"]!=="null"){availableLanguages.add(repo["Linguagem Principal"]);const lang=repo["Linguagem Principal"];tempLanguageCounts[lang]=(tempLanguageCounts[lang]||0)+1}if(repo.Licenca&&repo.Licenca!=="N/A"&&repo.Licenca!=="null"){availableLicenses.add(repo.Licenca)}})});calculatedTop5Languages=Object.entries(tempLanguageCounts).map(([language,count])=>({language:language,count:count})).sort((a,b)=>b.count-a.count).slice(0,10);populateFilter(languageFilter,Array.from(availableLanguages).sort());populateFilter(licenseFilter,Array.from(availableLicenses).sort());populateClustersTable();displayTop5LanguagesTable(calculatedTop5Languages);applyFiltersAndDisplay()}catch(error){console.error("Erro ao carregar ou processar os dados:",error)}}function populateFilter(selectElement,optionsArray){selectElement.innerHTML='<option value="">Todas</option>';optionsArray.forEach(optionText=>{const option=document.createElement("option");option.value=optionText;option.textContent=optionText;selectElement.appendChild(option)})}function getMostCommon(list){if(list.length===0)return"N/A";const counts={};let maxCount=0;let mostCommonItem="N/A";for(const item of list){counts[item]=(counts[item]||0)+1;if(counts[item]>maxCount){maxCount=counts[item];mostCommonItem=item}}return mostCommonItem}function updateGlobalStatistics(reposToConsider){let totalRepos=reposToConsider.length;const allLanguages=reposToConsider.map(repo=>repo["Linguagem Principal"]).filter(l=>l&&l!=="N/A"&&l!=="null");const allLicenses=reposToConsider.map(repo=>repo.Licenca).filter(l=>l&&l!=="N/A"&&l!=="null");totalReposGlobal.textContent=allFlattenedRepos.length;filteredReposCount.textContent=totalRepos;mostUsedLanguageGlobal.textContent=getMostCommon(allLanguages);mostUsedLicenseGlobal.textContent=getMostCommon(allLicenses)}function displayTop5LanguagesTable(data){topLanguagesTbody.innerHTML="";noTopLanguagesMessage.classList.add("hidden");if(!data||data.length===0){noTopLanguagesMessage.classList.remove("hidden");return}data.forEach((item,index)=>{const row=topLanguagesTbody.insertRow();row.insertCell().textContent=index+1;row.insertCell().textContent=item.language;row.insertCell().textContent=item.count})}function displayTop10ActiveRepos(reposData){topReposTbody.innerHTML="";noTopReposMessage.classList.add("hidden");const activeRepos=reposData.filter(repo=>repo["Ultima Atualizacao"]).sort((a,b)=>new Date(b["Ultima Atualizacao"]).getTime()-new Date(a["Ultima Atualizacao"]).getTime());const top10Repos=activeRepos.slice(0,10);if(top10Repos.length===0){noTopReposMessage.classList.remove("hidden");return}top10Repos.forEach(repo=>{const row=topReposTbody.insertRow();row.insertCell().innerHTML=`<a href="${repo["Link de Acesso"]}" target="_blank">${repo["Nome do Repositório"]}</a>`;row.insertCell().textContent=repo.SiglaInstituicao||"N/A";row.insertCell().textContent=repo["Linguagem Principal"]||"N/A";row.insertCell().textContent=`${repo.Estrelas} ⭐`;row.insertCell().textContent=repo["Ultima Atualizacao"]?new Date(repo["Ultima Atualizacao"]).toLocaleDateString("pt-BR"):"N/A"})}function displayAllReposTable(repos){allReposTbody.innerHTML="";if(repos.length===0){const row=allReposTbody.insertRow();const cell=row.insertCell();const numCols=document.querySelectorAll("#allReposTable thead th").length;cell.colSpan=numCols;cell.textContent="Nenhum repositório encontrado com os filtros aplicados.";cell.style.textAlign="center";cell.style.fontStyle="italic";cell.classList.add("no-results-message");return}repos.forEach(repo=>{const row=allReposTbody.insertRow();const repoNameCell=row.insertCell();const link=document.createElement("a");link.href=repo["Link de Acesso"];link.target="_blank";link.textContent=repo["Nome do Repositório"]||"N/A";repoNameCell.appendChild(link);row.insertCell().textContent=repo.SiglaInstituicao||repo.Instituicao||"N/A";row.insertCell().textContent=repo.Descricao||"N/A";row.insertCell().textContent=repo["Linguagem Principal"]||"N/A";row.insertCell().textContent=repo.Estrelas!==undefined?repo.Estrelas:"N/A";row.insertCell().textContent=repo.Licenca||"N/A";row.insertCell().textContent=repo["Ultima Atualizacao"]?new Date(repo["Ultima Atualizacao"]).toLocaleDateString("pt-BR"):"N/A";row.insertCell().textContent=repo["Cluster_ID"]!==undefined?repo["Cluster_ID"]:"N/A"})}function populateClustersTable(){clustersTbody.innerHTML="";noClustersMessage.classList.add("hidden");if(clusterDescriptions.length===0){noClustersMessage.classList.remove("hidden");clustersTbody.innerHTML='<tr><td colspan="2" class="no-results-message">Nenhuma descrição de cluster encontrada nos dados JSON.</td></tr>';return}const sortedClusterDescriptions=[...clusterDescriptions].sort((a,b)=>a.id-b.id);sortedClusterDescriptions.forEach(cluster=>{const row=clustersTbody.insertRow();row.insertCell().textContent=cluster.id;row.insertCell().textContent=cluster.description||"N/A"})}function applyFiltersAndDisplay(){let dataToProcess=[...allFlattenedRepos];const generalSearchTerm=generalSearchInput.value.toLowerCase().trim();const selectedLanguage=languageFilter.value;const selectedLicense=licenseFilter.value;dataToProcess=dataToProcess.filter(repo=>{const repoName=(repo["Nome do Repositório"]||"").toLowerCase();const repoDesc=(repo.Descricao||"").toLowerCase();const repoInst=(repo.Instituicao||"").toLowerCase();const repoSiglaInst=(repo.SiglaInstituicao||"").toLowerCase();const repoLang=(repo["Linguagem Principal"]||"").toLowerCase();const repoLicense=(repo.Licenca||"").toLowerCase();const matchesGeneralSearch=!generalSearchTerm||repoName.includes(generalSearchTerm)||repoDesc.includes(generalSearchTerm)||repoInst.includes(generalSearchTerm)||repoSiglaInst.includes(generalSearchTerm)||repoLang.includes(generalSearchTerm)||repoLicense.includes(generalSearchTerm);const matchesLanguage=!selectedLanguage||repoLang===selectedLanguage.toLowerCase();const matchesLicense=!selectedLicense||repoLicense===selectedLicense.toLowerCase();return matchesGeneralSearch&&matchesLanguage&&matchesLicense});allReposFilterInputs.forEach(input=>{const filterKey=input.dataset.filterKey;columnFilters[filterKey]=input.value.toLowerCase().trim()});dataToProcess=dataToProcess.filter(repo=>{for(const key in columnFilters){const filterValue=columnFilters[key];if(filterValue){let repoValue=repo[key];if(key==="Ultima Atualizacao"&&repoValue){repoValue=new Date(repoValue).toLocaleDateString("pt-BR")}else if(repoValue===null||repoValue===undefined){repoValue=""}else{repoValue=String(repoValue)}if(!repoValue.toLowerCase().startsWith(filterValue)){return false}}}return true});if(currentSortColumn){dataToProcess.sort((a,b)=>{let valA=a[currentSortColumn];let valB=b[currentSortColumn];if(valA===null||valA===undefined||valA==="N/A"||valA==="null")valA="";if(valB===null||valB===undefined||valB==="N/A"||valB==="null")valB="";if(currentSortColumn==="Estrelas"||currentSortColumn==="Cluster_ID"){valA=parseInt(valA)||0;valB=parseInt(valB)||0}else if(currentSortColumn==="Ultima Atualizacao"){valA=valA?new Date(valA).getTime():0;valB=valB?new Date(valB).getTime():0}else{valA=String(valA).toLowerCase();valB=String(valB).toLowerCase()}if(valA<valB)return currentSortDirection==="asc"?-1:1;if(valA>valB)return currentSortDirection==="asc"?1:-1;return 0})}updateGlobalStatistics(dataToProcess);displayTop10ActiveRepos(allFlattenedRepos);displayAllReposTable(dataToProcess)}generalSearchInput.addEventListener("input",applyFiltersAndDisplay);languageFilter.addEventListener("change",applyFiltersAndDisplay);licenseFilter.addEventListener("change",applyFiltersAndDisplay);allReposFilterInputs.forEach(input=>{input.addEventListener("input",applyFiltersAndDisplay)});clearFiltersBtn.addEventListener("click",()=>{generalSearchInput.value="";languageFilter.value="";licenseFilter.value="";allReposFilterInputs.forEach(input=>{input.value=""});columnFilters={};currentSortColumn=null;currentSortDirection="asc";allReposTableHeaders.forEach(th=>{th.classList.remove("asc","desc");const icon=th.querySelector("i.fas");if(icon&&th.dataset.sortKey){icon.className="fas fa-sort"}});applyFiltersAndDisplay()});allReposTableHeaders.forEach(header=>{if(header.dataset.sortKey){header.addEventListener("click",()=>{const column=header.dataset.sortKey;allReposTableHeaders.forEach(th=>{if(th.dataset.sortKey){th.classList.remove("asc","desc");const icon=th.querySelector("i.fas");if(icon&&th!==header){icon.className="fas fa-sort"}}});if(currentSortColumn===column){currentSortDirection=currentSortDirection==="asc"?"desc":"asc"}else{currentSortColumn=column;currentSortDirection="asc"}header.classList.add(currentSortDirection);const currentIcon=header.querySelector("i.fas");if(currentIcon){currentIcon.className=`fas fa-sort-${currentSortDirection==="asc"?"up":"down"}`}applyFiltersAndDisplay()})}});fetchAndProcessData()});